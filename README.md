
## Идея проекта

Ed-tech продукт "Сервис подготовки и проведения инженерно-математических олимпиад"

## АРХИТЕКТУРА
### 1. Общая архитектура

**Подход:**

- Backend: микросервисно-монолитный подход — один основной сервис (FastAPI) + отдельные сервисы для тяжёлых вещей (генерация дипломов, отправка писем, возможно — подсчёт результатов).
- Развёртывание: контейнеры (Docker) + оркестрация (Kubernetes или как минимум Docker Compose на первом этапе).
- Масштабирование: горизонтальное (несколько экземпляров backend + несколько экземпляров БД/кэша и т.д.) за балансировщиком.
    

---

### 2. Backend

#### Основной API-сервис

- **Фреймворк:**
    - `FastAPI` — как ты и хочешь: быстро, асинхронно, удобно для типизации и автодокументации.

- **ASGI-сервер:**
    - `uvicorn` (с `gunicorn` в проде: `gunicorn -k uvicorn.workers.UvicornWorker ...`).
        
- **Основные задачи сервиса:**
    
    - Регистрация родителя и ребёнка
    - Аутентификация / авторизация.
    - Управление олимпиады: этапы, предметы, задания, таймеры.
    - Приём ответов, проверка (выбор варианта / краткий ответ).
    - API для личных кабинетов (родитель, участник, организатор).
    - Ведение логов действий (на случай апелляций).
        

#### Валидация и сериализация
- `pydantic` (встроен в FastAPI) — для схем запросов/ответов, моделей настроек.
- Пароли: минимум 8 символов, обязательно хотя бы одна строчная, одна заглавная и одна цифра.

#### Формат ошибок API
Все ошибки возвращаются единообразно:

```json
{
  "error": {
    "code": "some_error_code",
    "message": "some_error_code",
    "details": {}
  }
}
```

- `code` — стабильный код ошибки для обработки на фронте.
- `message` — человекочитаемое описание (по умолчанию совпадает с `code`).
- `details` — необязательные детали (например, список полей валидации).

Примеры кодов:
- `validation_error`
- `internal_error`
- `invalid_credentials`, `email_not_verified`
- `weak_password`
- `missing_token`, `invalid_token`, `invalid_token_type`
- `forbidden`, `user_not_found`, `olympiad_not_found`, `task_not_found`

#### Запуск через Docker Compose

```bash
docker compose up --build
```

- API: `http://localhost:8000/api/v1/health`
- Миграции: `docker compose exec api alembic -c /app/alembic.ini upgrade head`
    

---

### 3. Базы данных и хранение

#### Основная транзакционная БД

- **СУБД:**
    - `PostgreSQL` — надёжный стандарт для такого рода систем.
- **Что хранить:**
    - Пользователи (родители, дети, админы).
    - Олимпиады, этапы, задания, варианты ответов.
    - Попытки прохождения, результаты, логи.
    - Метаданные по сертификатам/дипломам (а сами PDF — в объектном хранилище).
        
- **ORM/слой доступа:**
    - `SQLAlchemy 2.x` + `alembic` для миграций.
        
- **Особое внимание:**
    
    - Индексы по:
        - `user_id`
        - `child_id`
        - `olympiad_id`
        - `attempt_id`
    - Хорошо продумать модель попыток: отдельная таблица для «сессии» прохождения олимпиады.
        

#### Кэш и сессии

- **Кэш/сессии/блокировки:**
    - `Redis`
        - Кэш заданий (чтобы не дергать БД на каждый запрос).
        - Состояние сессий тестирования, таймеров.
        - Rate limiting, защита от накрутки.
        - Очереди задач (через Celery / RQ, если использовать Redis как брокер).
            

---

### 4. Очереди и фоновые задачи

Некоторые операции лучше вынести из синхронного запроса:

- Генерация PDF-дипломов.
- Массовая рассылка писем.
- Постобработка результатов (подсчёт рейтингов, награды и т.п.).
    

**Стек:**

- **Очередь/брокер сообщений:**
    - Вариант 1 (классика): `RabbitMQ`.
    - Вариант 2 (попроще): `Redis` как брокер.
        
- **Фреймворк фоновых задач:**
    - `Celery` — зрелый и привычный.
    - Либо `RQ`/`Huey`, если хочешь чуть проще.
        

---

### 5. Генерация дипломов

- **Формат:** PDF.
- **Варианты стека:**
    
    1. **HTML → PDF:**
        - Рендер HTML-шаблонов (Jinja2 в FastAPI) и конвертация в PDF:
            - `WeasyPrint` или `wkhtmltopdf` (через библиотеку типа `pdfkit`).
        - Плюс в том, что дизайн можно править как обычную веб-страницу.
            
    2. **Python-библиотеки:**
        - `reportlab` для генерации PDF программно (если нужен суперточный контроль, но дизайн сложнее править).
            
- **Хранение:**
    
    - Объектное хранилище:
        - S3-совместимое: MinIO (self-hosted) / облачный S3.
    - В БД хранить только путь/ключ к файлу + метаданные.
        

---

### 6. Frontend

Чтобы родителям и детям было приятно этим пользоваться:

- **Вариант 1 (современный SPA):**
    
    - `React` + `TypeScript`.
    - UI-библиотека: `MUI`, `Ant Design` или `Chakra UI`.
    - Обмен данными: REST по HTTPS (можно при желании GraphQL).
        
- **Вариант 2 (проще, но тоже рабочий):**
    
    - Server-side рендеринг: `Jinja2` + классический HTML/CSS + немного JS.
    - Для онлайн-теста можно добавить легкий Vue/React только для страниц с заданиями.
        

С учётом 10k одновременных пользователей я бы делал отдельный SPA, статически отдаваемый с CDN / object storage, а backend только как API.

---

### 7. Таймеры, защита от читерства и корректность

#### Таймеры и ограничение по времени

- Таймер на клиенте (JS), но **истина на стороне сервера**:
    
    - При старте попытки — записываем `started_at`, `duration`, `deadline` в БД/Redis.
    - При каждом сохранении ответа сервер проверяет, не истекло ли время.
    - Можно хранить «снимок» в Redis, а по завершению/истечении — фиксировать попытку в PostgreSQL.

#### Защита / честность

Полностью «честной» онлайн-олимпиады не бывает, но базовые меры:

- Ограничение количества одновременных сессий для одного ребёнка.
- Случайная подмешка порядка вопросов/вариантов.
- Лимит API-запросов с одного IP (через Nginx/Traefik + Redis).
- Логирование: IP, user agent, время ответов (подозрительно быстрые — маркер).
    

---

### 8. Инфраструктура и отказоустойчивость

#### Контейнеризация

- **Docker** — собрать image для backend, worker’ов, фронта.
- Общий docker-compose для локальной разработки (Postgres, Redis, MinIO, RabbitMQ).

#### Оркестрация (прод)

- **Kubernetes** (k8s) или managed-решение в облаке (EKS, GKE, AKS или Yandex Cloud / VK Cloud — в зависимости от юрисдикции).
    
- Минимум:
    - Deployment для FastAPI (несколько реплик).
    - Deployment для Celery worker’ов.
    - StatefulSet для PostgreSQL (или использовать managed БД).
    - Redis как Deployment или managed-сервис.
    - Ingress-контроллер (Nginx Ingress / Traefik).

#### Балансировщик и SSL

- **Nginx / Traefik** как reverse proxy:
    - Терминация TLS (Let’s Encrypt / ваш сертификат).
    - Балансировка между репликами FastAPI.
    - Rate limiting, защита от некоторых видов атак.

#### Мониторинг и логирование
- Логи:
    - `Prometheus` + `Grafana` для метрик.
    - `Loki` / `ELK` (Elasticsearch + Logstash + Kibana) для логов.
        
- APM:
    - Sentry / New Relic / Elastic APM — отслеживать ошибки и задержки.
        

---

### 9. Аутентификация и безопасность

- **Аутентификация:**
    
    - JWT (access + refresh токены).
    - Для родителей — авторизация по email + пароль, плюс возможность входа по одноразовому коду на email.
        
- **Защита:**
    
    - HTTPS везде.
    - Хранение паролей — только хэши (`argon2` / `bcrypt`).
    - CSRF защита, если будут классические формы
    - Регулярные бэкапы БД (естественно, зашифрованные и с тестами восстановления).
        

---

### 10. Масштабирование под 10 000 одновременных

Грубый набросок:

- Несколько экземпляров FastAPI:
    - Например, 8–12 pod’ов, по 2–4 воркера каждый (на старте, потом посмотреть по метрикам).
        
- Redis и PostgreSQL — как минимум:
    - Отдельные мощные инстансы / managed-сервисы.
    - Включить connection pooling для БД:
        - `pgBouncer` или аналог.

- Сильный упор на кэширование:
    - Задания, статичные данные олимпиады — через Redis и/или прогретые в память.
- Статику (фронт, изображения, шаблоны дипломов) — на CDN.
    

---



## Роли и права пользователей


### 1. Администратор / admin - superuser

#### Права

- Создается единожды, может существовать только в одном экзепляре
- Имеет доступ в панель управления олимпиадами
- Может создавать, редактировать и загружать задачи в Task bank
- Может создавать, изменять, публиковать олимпиады
- Видит результаты каждого ученика
- Может видеть список всех пользователей по типу student, teacher
- Может видеть список участников каждой олимпиады и их результаты
- Может редактировать или удалять попытку attempts прохождения олимпиады учеником  
- Может добавлять новых пользователей student, teacher
- Может изменять информацию в записях пользователя
- Может менять пароль доступа любого пользователя
- Может создавать и публиковать статьи (длинные текстовые записи на отдельной странице сайта)
- Может создавать и публиковать новости (короткие сообщения на сайте)
- Может разрешать/запрещать учителю становиться модератором по запросу учителя

#### DataBase admin model

- name admin
- password


### 2. Учитель / teacher

#### Права

- Регистрация на сайте
- Доступ к своему личному кабинету
- Может изменять информацию в своем личном кабинете
- Может создавать свою группу (класс) учеников
- Может добавлять в свою группу/класс учеников. Если ученик зарегистрирован, то после его подтверждения. Если ученик не зарегистрирован, создается ссылка на регистрацию с последующим автоматическим добавлением ученика в свой класс
- Может заходить в личный кабинет своих учеников
- Может менять запись в поле city / school / grade у пользователя student
- Может просматривать результаты прохождения олимпиады своих учеников в dashboard
- Может скачивать дипломы о прохождении олимпиады своих учеников
- Может запросить у admin статус модератора
- Если модератор, может создавать и загружать задания в task bank
- Если модератор, может создавать и публиковать статьи (длинные текстовые записи на отдельной странице сайта)
- Если модератор, может создавать и публиковать новости (короткие сообщения на сайте)

#### DataBase teacher model

**Поля, заполняемые при регистрации пользователя**
- login - unique (Валидация: Только английские буквы и цифры, первый символ - буква, не менее 5 символов) - доступ по логину
- password - (обязательно доступно восстановление пароля через email)
- email - обязательное поле (процедура верификации)
- surname - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- name - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- father name - необязательное поле (Валидация: Только кириллица, первая буква заглавная)
- country - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- city - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- school - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- subject - обязательное поле (Валидация: Только кириллица, первая буква заглавная)

**Служебные поля**
- id - primary key
- creation_date - дата и время регистрации пользователя
- diploma - ссылки на pdf благодарственные письма от сервиса
- students (список ids) - связь по id с учениками
- moderator (true/false) - статус модератора по запросу к admin
- tasks - список ids созданных заданий, если moderator == true
- articles - список ids созданных статей, если moderator == true
- news- список ids созданных новостей, если moderator == true

### 3. Ученик / student

#### Права

- Регистрация на сайте
- Доступ к своему личному кабинету
- Может изменять информацию в своем личном кабинете
- Может участвовать в доступных олимпидах
- Может отправить запрос пользователю teacher для добавления в его класс\группу
- Может отвечать на запрос добавления от учителя
- Может быть связан с несколькими учителями
- Может просматривать результаты своего прохождения всех олимпиады, в которых он участвовал
- Может скачивать диплом о прохождении олимпиады в своем личном кабинете
- Может просматривать свое решение каждого отдельного задания олимпиады (видеть свой выбор ответа, время решения, длительность решения, но не правильный ответ на задание)

#### DataBase student model

**Поля, заполняемые при регистрации пользователя**
- login - unique (Валидация: Только английские буквы и цифры, первый символ - буква, не менее 5 символов) - доступ по логину
- password - (обязательно доступно восстановление пароля через email)
- email - обязательное поле (процедура верификации)
- surname - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- name - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- father name - необязательное поле (Валидация: Только кириллица, первая буква заглавная)
- country - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- city - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- school - обязательное поле (Валидация: Только кириллица, первая буква заглавная)
- grade - обязательное поле (Валидация: Только целое число от 0 до 11)

**Служебные поля**
- id - primary key
- creation_date - дата и время регистрации пользователя
- diploma - ссылки на pdf дипломы прохождения олимпиады
- teachers (список ids) - связь по id с учителями
- attempts  - список ids попыток (attempts) прохождения олимпиад


---
## Основные сущности сервиса

### 1) Задания (Task bank) — правила

#### 1.1. Предмет

Каждое задание принадлежит ровно одному предмету:

- `subject ∈ {math, cs}` (Математика, Информатика)

Задания хранятся в **банке заданий** (единая база по предмету).

#### 1.2. Типы задания (ответ и автопроверка)

Поддерживаем 3 типа:

1. **Single choice** (один вариант)

- хранится список вариантов
- правильный: индекс/ID одного варианта

2. **Multiple choice** (множественный выбор)

- хранится список вариантов
- правильный: множество ID вариантов
- правило сравнения: множество выбранных должно совпасть (без лишних)

3. **Short text** (краткий текстовый ответ) с валидацией:

- `text_subtype ∈ {int, float, text}`
- `int`: допустим только целочисленный формат (после trim)
- `float`: допустим дробный формат (разрешить `.` и `,`, нормализовать к `.`)
- `text`: строка, не чувствительная к регистру (case-insensitive), обязательно trim

**Автопроверка short text**:

- `int`: `parsed_int == expected_int`
    
- `float`: `abs(parsed_float - expected_float) <= epsilon` (epsilon задаётся на олимпиаде или на задании)
    
- `text`: `normalize(user) == normalize(expected)` где normalize: trim + lower + (опционально) collapse spaces
    

#### 1.3. Картинка в задании

Задание может включать  картинки, хранятся как:

- `image_key` в S3/MinIO (или локально в dev), в БД только ключ/URL.

#### 1.4 DataBase Tasks model

- `tasks`
    
    - `id`
    - `subject` (math/cs)
    - `create_date`
    - `created_by` - admin / teacher's id
    - `title`
    - `task_type` (single_choice/multi_choice/short_text)
    - `image_key` nullable
    - `content` 
    - `payload` (JSONB): варианты/ожидаемый ответ/настройки (см. ниже)
        

Рекомендуемый `payload`:

- single_choice:
    
    - `{"options":[{"id":"A","text":"..."},...], "correct_option_id":"B"}`
        
- multi_choice:
    
    - `{"options":[...], "correct_option_ids":["A","C"]}`
        
- short_text:
    
    - `{"subtype":"int|float|text", "expected":"...", "epsilon":0.01, "case_insensitive":true}`  
        (epsilon только для float; case_insensitive только для text)

---

### 2) Олимпиады — правила создания и доступа

#### 2.1. Источник заданий

- **Админ** формирует **глобальную** олимпиаду из задач банка для всех учеников.

#### 2.2. Кому доступна олимпиада

- доступна **всем ученикам** определенной возрастной группы (1 класс, 2 класс, 3-4 класс, 5-6 класс, 7-8 класс)

#### 2.3. Параметры олимпиады при создании

Админ задаёт:

1. **Разбалловка (scoring)**

- для каждого включённого задания задаётся `max_score` (целое)
- итоговый максимум = сумма `max_score`

1. **Критерии успешности**

- минимум для “успешно пройдено”, например:
    
    - `pass_percent` (например 60%)
    - или `pass_score` (например 18 баллов)  
        Для простоты MVP: фиксируем один вариант `pass_percent` (0–100), а `pass_score` вычисляем.

3. **Количество попыток**

- `attempts_limit`  только 1 

3. **Время на прохождение**
- `duration_sec`
    

3. **Срок доступа**

- `available_from`, `available_to` (datetime)
- Ученик может стартовать попытку только если сейчас в этом интервале.
    

#### 2.4. Правила попыток

- Ученик может начать попытку если:
    
    - олимпиада опубликована
    - сейчас в окне доступности
    - число завершённых/начатых попыток < `attempts_limit`
    - при случайном закрытии сессия не обрывается
        
- Попытка имеет `deadline_at = started_at + duration_sec`
    
- Отправка ответов возможна только пока:
    
    - `status=active`
    - и `now <= deadline_at`
        

### 2.5. Автооценка

- Оценивание происходит автоматически на `submit`:
    
    - для каждого задания вычисляется корректность/балл
    - фиксируется итог: `score_total`, `score_max`
        
- Учителю показывается успешность учеников его класса (процент,  время).
- Ученик видит результат (процент и время). Также ученик видит задания и свой выбор ответов. Без указания верно или нет.
    

#### 2.6 DataBase Olympiads model

- `olympiads`
    
    - `id`
    - `create_date
    - `title`, `description`
    - `duration_sec`
    - `attempts_limit` = 1
    - `available_from`, `available_to`
    - `pass_percent`
    - `is_published`
        
- `olympiad_tasks` (связка)
    
    - `id`
    - `olympiad_id`
    - `task_id` (ссылка на bank task)
    - `sort_order`
    - `max_score` (разбалловка именно в олимпиаде)
        

### 3) Попытки прохождения олимпиады

### DataBase Attempts model

- `attempts`
    
    - `id`, `olympiad_id`, `user_id`
    - `started_at`, `deadline_at`, `status`
    - `score_total`, `score_max`, `passed`, `graded_at`
        
- `attempt_answers`
    
    - `attempt_id`, `task_id`
    - `answer_payload` (JSONB): чтобы поддерживать выборы и текст единообразно
    - `updated_at`
        
- `attempt_task_grades`
    
    - `attempt_id`, `task_id`
    - `is_correct`
    - `score`
    - `max_score`
    - `graded_at`
        
