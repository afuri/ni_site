# Codex Rules — NI_SITE / «Невский интеграл»

Этот файл задаёт правила для работы Codex CLI/агента с проектом «Сервис подготовки и проведения инженерно‑математических олимпиад».

## 1) Контекст продукта и приоритеты
- Продукт: EdTech‑платформа для проведения онлайн‑олимпиад по **математике** и **информатике**.
- Роли: **admin (superuser, единственный экземпляр)**, **teacher**, **student**.
- Ключевые нефункциональные требования: корректность тайминга (истина на сервере), масштабирование до **~10 000 одновременных пользователей**, аудит/логи для апелляций.

## 2) Технологический стек (фиксируем как «истина проекта»)
Backend:
- FastAPI (async), Pydantic (схемы/валидация).
- ASGI: uvicorn; prod: gunicorn + uvicorn worker.
- PostgreSQL как основная транзакционная БД.
- SQLAlchemy 2.x + Alembic для миграций.
- Redis: кэш, сессии/таймеры, rate limiting, распределённые блокировки.
- Фоновые задачи: Celery (broker RabbitMQ или Redis).
Хранилища:
- S3‑совместимое object storage (MinIO в self‑hosted/dev): PDF дипломов/сертификатов, изображения задач.
Frontend (возможные варианты):
- Приоритетно: SPA (React + TypeScript) как отдельная статика (CDN/object storage).
- Допустимо для MVP: SSR на Jinja2 + лёгкий JS/Vue/React для страниц тестирования.

## 3) Архитектурные принципы
- Подход: «микросервисно‑монолитный»: один основной API‑сервис + отдельные сервисы/воркеры для тяжёлых операций (PDF, рассылки, пост‑подсчёты).
- Развёртывание: Docker (dev), в дальнейшем k8s; минимум — docker-compose.
- Масштабирование: горизонтальное (несколько реплик API + отдельные воркеры, балансировщик перед API).
- Обязателен connection pooling для Postgres (pgBouncer/аналог) на проде.

## 4) Безопасность и аутентификация
- Аутентификация: JWT access + refresh.
- Пароли: только хэш (argon2 или bcrypt). Никогда не логировать пароли/токены.
- HTTPS везде; CSRF нужен только для классических форм (если будут).
- Email‑верификация и восстановление пароля для teacher/student обязательны.

## 5) Доменные правила (бизнес‑логика, которую нельзя «ломать»)
### 5.1 Роли и права
- Admin: единственный superuser; полный доступ к управлению олимпиадами, заданиями (task bank), пользователями, попытками, публикациям (articles/news), назначению teacher модератора.
- Teacher: управляет классом, может смотреть результаты своих учеников, скачивать их дипломы; может запросить статус модератора.
- Moderator (teacher.moderator=true): может создавать задания в task bank и публиковать articles/news.
- Student: участвует в доступных олимпиадах, видит свои результаты и свои ответы/время, **но не видит правильность по заданиям**.

### 5.2 Валидация полей регистрации (строго)
Login (teacher/student):
- уникальный
- только латиница и цифры
- первый символ — буква
- длина ≥ 5
ФИО/страна/город/школа/предмет (teacher) и ФИО/страна/город/школа (student):
- только кириллица
- первая буква заглавная
Grade (student):
- целое число 0..11

### 5.3 Task bank (банк заданий)
Предмет:
- `subject ∈ {math, cs}`

Типы заданий:
1) `single_choice`
- варианты options[]
- правильный вариант: `correct_option_id`
2) `multi_choice`
- варианты options[]
- правильные: `correct_option_ids[]`
- сравнение как множества: выбранные должны совпасть без лишних
3) `short_text`
- `subtype ∈ {int, float, text}`
- `int`: после trim допускается только целое
- `float`: допускается `.` и `,`, нормализуем в `.`, сравнение по epsilon
- `text`: trim, регистронезависимо, опционально collapse spaces

Изображение задания:
- хранить в object storage (S3/MinIO); в БД — только ключ/URL (`image_key`).

Payload (рекомендуемый контракт JSONB):
- single_choice: `{"options":[{"id":"A","text":"..."}], "correct_option_id":"B"}`
- multi_choice: `{"options":[...], "correct_option_ids":["A","C"]}`
- short_text: `{"subtype":"int|float|text","expected":"...","epsilon":0.01,"case_insensitive":true}`

### 5.4 Олимпиады
- Олимпиаду формирует **admin** из заданий task bank.
- Доступность: всем ученикам заданной возрастной группы (1,2,3-4,5-6,7-8 классы).
- Параметры:
  - `duration_sec`
  - `attempts_limit = 1` (фиксировано для MVP)
  - окно доступности: `available_from`, `available_to`
  - проходной порог: `pass_percent` (0–100); `pass_score` вычисляется
  - публикация: `is_published`

### 5.5 Попытки (Attempts)
- Ученик может начать попытку, если:
  - олимпиада опубликована
  - текущее время в окне доступности
  - количество начатых/завершённых попыток < attempts_limit
  - случайное закрытие сессии не «обрывает» попытку (нужна серверная сессия/восстановление)
- `deadline_at = started_at + duration_sec`
- сервер — единственный источник истины по времени: ответы принимаются только при `status=active` и `now <= deadline_at`.
- Оценивание происходит на `submit` (автопроверка):
  - фиксировать `score_total`, `score_max`, `passed`, `graded_at`
  - ученик видит процент и время и свои ответы, **но не видит верно/неверно по каждому заданию**.
  - teacher видит успешность/время учеников своего класса.

## 6) Модели данных (ориентиры)
Ожидаемые таблицы (как минимум):
- `users`/`teachers`/`students` (или единая таблица + role; важно сохранить поля и правила валидации)
- `tasks` (JSONB payload)
- `olympiads`
- `olympiad_tasks` (связка + sort_order + max_score)
- `attempts`
- `attempt_answers` (JSONB answer_payload)
- `attempt_task_grades`

Индексы обязательны по:
- `user_id`, `child_id` (если есть раздельные сущности), `olympiad_id`, `attempt_id`.

## 7) API и контрактность
- Любые изменения схем API должны сопровождаться обновлением Pydantic‑схем и автодокументации OpenAPI.
- Ошибки — структурированные (HTTP status + code + message + details).
- Идемпотентность:
  - повторная отправка ответа в рамках активной попытки должна корректно обновлять `attempt_answers.updated_at`.
  - `submit` должен быть защищён от повторной отправки (например, CAS/lock в Redis).

## 8) Фоновые задачи
Выносить из синхронного запроса:
- генерацию PDF дипломов/сертификатов
- массовые email‑рассылки
- пост‑обработку результатов (рейтинги/награды)

Генерация PDF:
- предпочтительно HTML→PDF (Jinja2 + WeasyPrint/wkhtmltopdf) для управляемого дизайна;
- допускается ReportLab при необходимости точного контроля.
Хранение PDF:
- object storage; в БД — только ключ и метаданные.

## 9) Логи, мониторинг, аудит
- Вести аудит действий (особенно для апелляций): кто/что/когда/с какого IP/UA.
- Метрики и логи на проде: Prometheus+Grafana; Loki/ELK; ошибки: Sentry/аналог.

## 10) Инфраструктура, конфигурация, секреты
- Все конфиги через env (12‑factor): DATABASE_URL, REDIS_URL, S3_ENDPOINT/KEY/SECRET, JWT_SECRET и т.д.
- Секреты не коммитить. Для dev допускается `.env.example`.
- Docker‑окружение должно поднимать минимум: API, Postgres, Redis, MinIO, broker (RabbitMQ/Redis), worker.

## 11) Правила разработки (что Codex должен соблюдать)
- Не менять доменные правила из раздела 5 без явного указания пользователя.
- Перед изменениями схем БД:
  - обновить модели SQLAlchemy
  - создать миграцию Alembic
  - убедиться, что миграции применяются на чистой БД.
- Следовать стилю проекта:
  - типизация обязательна (mypy/pyright если подключены)
  - форматирование: black/ruff (если есть), не смешивать стили
- Покрывать ключевую бизнес‑логику тестами (pytest):
  - валидации регистрации
  - автопроверка short_text (int/float/text)
  - правила дедлайна и submit
  - single/multi choice сравнение множеств
- Оптимизация:
  - минимизировать запросы к БД на страницах прохождения (кэшировать задания, использовать Redis)
  - помнить про 10k concurrency: не блокировать event loop; тяжёлое — в воркеры.

## 12) «Красные флаги» (что запрещено)
- Хранить PDF/картинки в Postgres как большие бинарные поля (кроме крайней необходимости).
- Делать клиентский таймер «истиной» — только сервер.
- Показывать ученику правильные ответы или верность по конкретным заданиям.
- Игнорировать attempts_limit=1 для MVP.
- Логировать персональные данные без необходимости (и тем более пароли/токены).

---

Источник правил: спецификация проекта «Невский интеграл».
